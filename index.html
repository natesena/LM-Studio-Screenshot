<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Screenshot Sender</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f7f7fa; color: #222; min-height: 100vh; }
    .container { width: 100%; min-height: 100vh; margin: 0; background: #fff; border-radius: 0; box-shadow: none; padding: 2em 0 3em 0; position: relative; display: flex; flex-direction: column; align-items: center; }
    .header { width: 100%; max-width: 900px; display: flex; align-items: center; justify-content: space-between; }
    .title { font-size: 2em; font-weight: 600; }
    .gear-btn { background: none; border: none; cursor: pointer; font-size: 1.6em; color: #888; transition: color 0.2s; }
    .gear-btn:hover { color: #222; }
    .screenshot-section { text-align: center; margin-top: 2em; width: 100%; max-width: 900px; }
    #screenshotPreview { max-width: 100%; max-height: 320px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fafbfc; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
    .screenshot-actions { margin-top: 1.5em; display: flex; justify-content: center; gap: 2em; }
    .screenshot-actions button { font-size: 1.25em; padding: 1em 2.5em; border-radius: 8px; border: none; font-weight: 600; background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); color: #fff; box-shadow: 0 2px 8px rgba(59,130,246,0.08); transition: background 0.2s, transform 0.1s; cursor: pointer; letter-spacing: 0.03em; }
    .screenshot-actions button:active { transform: scale(0.98); }
    .screenshot-actions button:disabled { background: #bcd1f7; color: #fff; cursor: not-allowed; }
    .screenshot-info { margin-top: 0.5em; color: #666; font-size: 0.95em; }
    .chat-section { margin-top: 2em; width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 1.5em; }
    .chat-message { display: flex; gap: 1em; align-items: flex-start; }
    .chat-message.user { flex-direction: row-reverse; }
    .chat-message .avatar { width: 40px; height: 40px; border-radius: 50%; background: #e0e7ef; display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; color: #3b82f6; }
    .chat-message.user .avatar { background: #dbeafe; color: #2563eb; }
    .chat-bubble { background: #f3f4f6; border-radius: 12px; padding: 1em 1.2em; font-size: 1.08em; max-width: 70%; box-shadow: 0 1px 4px rgba(0,0,0,0.03); word-break: break-word; }
    .chat-message.user .chat-bubble { background: #e0e7ef; text-align: right; }
    .chat-message img { max-width: 220px; max-height: 180px; border-radius: 8px; border: 1px solid #e0e0e0; background: #fafbfc; }
    /* Modal styles */
    .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 100; }
    .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; border-radius: 10px; box-shadow: 0 4px 32px rgba(0,0,0,0.18); padding: 2em 2.5em; min-width: 320px; z-index: 101; display: flex; flex-direction: column; gap: 1.2em; }
    .modal label { font-weight: 500; margin-bottom: 0.2em; }
    .modal input { width: 100%; padding: 0.5em; border-radius: 5px; border: 1px solid #ddd; font-size: 1em; }
    .modal .modal-actions { display: flex; justify-content: flex-end; gap: 1em; margin-top: 1em; }
    .modal .modal-actions button { padding: 0.5em 1.2em; border-radius: 5px; border: none; font-size: 1em; cursor: pointer; }
    .modal .modal-actions .save-btn { background: #3b82f6; color: #fff; }
    .modal .modal-actions .cancel-btn { background: #eee; color: #333; }
    @media (max-width: 900px) {
      .header, .screenshot-section, .chat-section { max-width: 100vw; }
    }
    @media (max-width: 700px) {
      .container { padding: 1em 0 2em 0; }
      .modal { min-width: 90vw; }
      .screenshot-actions button { font-size: 1em; padding: 0.8em 1.5em; }
      .chat-message .avatar { width: 32px; height: 32px; font-size: 1.1em; }
      .chat-bubble { font-size: 1em; padding: 0.7em 1em; }
      .chat-message img { max-width: 120px; max-height: 100px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="title">Screenshot Sender</span>
      <button class="gear-btn" id="openSettings" title="Settings">&#9881;</button>
    </div>
    <div class="screenshot-section">
      <div class="screenshot-info" id="screenshotInfo"></div>
      <div class="screenshot-actions">
        <button id="screenshotBtn">Take Screenshot</button>
        <button id="sendBtn" disabled>Send to LLM</button>
      </div>
    </div>
    <chat-area id="chatArea"></chat-area>
  </div>
  <!-- Settings Modal -->
  <div class="modal-bg" id="modalBg"></div>
  <div class="modal" id="settingsModal" style="display:none;">
    <label>Model
      <input id="model" value="gemma-3-4b-it-qat">
    </label>
    <label>Max Tokens
      <input id="max_tokens" type="number" value="50">
    </label>
    <label>Temperature
      <input id="temperature" type="number" step="0.01" value="0.7">
    </label>
    <label>Window Title (optional)
      <input id="windowTitle" placeholder="Leave blank for full screen">
    </label>
    <label>Prompt (optional)
      <input id="prompt" placeholder="Describe this image">
    </label>
    <div class="modal-actions">
      <button class="save-btn" id="saveSettings">Save</button>
      <button class="cancel-btn" id="cancelSettings">Cancel</button>
    </div>
  </div>
  <script>
    // ChatArea component
    class ChatArea extends HTMLElement {
      constructor() {
        super();
        this.messages = [];
        this.attachShadow({ mode: 'open' });
        this.render();
      }
      addMessage(message) {
        this.messages.push(message);
        this.render();
      }
      render() {
        this.shadowRoot.innerHTML = `
          <div class="chat-section">
            ${this.messages.map(msg => `
              <div class="chat-message ${msg.role}">
                <div class="avatar">${msg.role === 'user' ? 'üñºÔ∏è' : 'ü§ñ'}</div>
                <div class="chat-bubble">
                  ${msg.role === 'user' ? `<img src="file://${msg.imagePath}" alt="Screenshot" />` : `<div>${msg.content}</div>`}
                </div>
              </div>
            `).join('')}
          </div>
          <style>${document.querySelector('style').innerHTML}</style>
        `;
      }
    }
    customElements.define('chat-area', ChatArea);

    // Settings state
    let settings = {
      model: 'gemma-3-4b-it-qat',
      max_tokens: 50,
      temperature: 0.7,
      windowTitle: '',
      prompt: ''
    };
    let screenshotPath = null;
    const screenshotBtn = document.getElementById('screenshotBtn');
    const sendBtn = document.getElementById('sendBtn');
    const screenshotInfo = document.getElementById('screenshotInfo');
    const screenshotPreview = null; // not used anymore
    const chatArea = document.getElementById('chatArea');
    // Modal elements
    const openSettingsBtn = document.getElementById('openSettings');
    const modalBg = document.getElementById('modalBg');
    const settingsModal = document.getElementById('settingsModal');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const cancelSettingsBtn = document.getElementById('cancelSettings');
    // Settings fields
    const modelInput = document.getElementById('model');
    const maxTokensInput = document.getElementById('max_tokens');
    const temperatureInput = document.getElementById('temperature');
    const windowTitleInput = document.getElementById('windowTitle');
    const promptInput = document.getElementById('prompt');

    function humanFileSize(bytes) {
      const thresh = 1024;
      if (Math.abs(bytes) < thresh) {
        return bytes + ' B';
      }
      const units = ['KB','MB','GB','TB','PB','EB','ZB','YB'];
      let u = -1;
      do {
        bytes /= thresh;
        ++u;
      } while(Math.abs(bytes) >= thresh && u < units.length - 1);
      return bytes.toFixed(1)+' '+units[u];
    }

    // Modal logic
    openSettingsBtn.onclick = () => {
      // Populate modal fields
      modelInput.value = settings.model;
      maxTokensInput.value = settings.max_tokens;
      temperatureInput.value = settings.temperature;
      windowTitleInput.value = settings.windowTitle;
      promptInput.value = settings.prompt;
      modalBg.style.display = 'block';
      settingsModal.style.display = 'flex';
    };
    cancelSettingsBtn.onclick = () => {
      modalBg.style.display = 'none';
      settingsModal.style.display = 'none';
    };
    saveSettingsBtn.onclick = () => {
      settings.model = modelInput.value;
      settings.max_tokens = parseInt(maxTokensInput.value, 10);
      settings.temperature = parseFloat(temperatureInput.value);
      settings.windowTitle = windowTitleInput.value;
      settings.prompt = promptInput.value;
      modalBg.style.display = 'none';
      settingsModal.style.display = 'none';
    };
    modalBg.onclick = cancelSettingsBtn.onclick;

    screenshotBtn.onclick = async () => {
      screenshotInfo.textContent = '';
      try {
        const result = await window.electronAPI.takeScreenshot(settings.windowTitle || undefined);
        screenshotPath = result.tmpPath;
        // Calculate size
        const stats = await window.electronAPI.getFileStats(screenshotPath);
        screenshotInfo.textContent = `Screenshot size: ${stats.size} bytes (${humanFileSize(stats.size)})`;
        sendBtn.disabled = false;
        // Add screenshot to chat as user message
        chatArea.addMessage({ role: 'user', imagePath: screenshotPath });
      } catch (err) {
        screenshotInfo.textContent = 'Error: ' + err;
        sendBtn.disabled = true;
      }
    };

    sendBtn.onclick = async () => {
      try {
        chatArea.addMessage({ role: 'assistant', content: 'Thinking...' });
        const result = await window.electronAPI.sendToLLM({
          model: settings.model,
          prompt: settings.prompt,
          max_tokens: settings.max_tokens,
          temperature: settings.temperature,
          imagePath: screenshotPath
        });
        // Remove the 'Thinking...' message and add the real response
        chatArea.messages.pop();
        // Use only the main content from the LLM response
        chatArea.addMessage({ role: 'assistant', content: result.content || result.nonReasoningContent || 'No response.' });
      } catch (err) {
        chatArea.addMessage({ role: 'assistant', content: 'Error: ' + err });
      }
    };
  </script>
</body>
</html> 